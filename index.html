  <head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <!-- Base tag to ensure relative URLs resolve correctly regardless of route -->
    <script>
      (function() {
        // Detect base path from current location
        const pathname = window.location.pathname
        // Extract base path (e.g., '/mig_2026/' from '/mig_2026/cars/stock')
        const match = pathname.match(/^(\/[^/]+\/)/)
        const basePath = match ? match[1] : '/'
        
        // Create and insert <base> tag
        const baseTag = document.createElement('base')
        baseTag.href = basePath
        document.head.insertBefore(baseTag, document.head.firstChild)
      })()
    </script>
    <link rel="icon" href="./logo_default.png" type="image/png" id="favicon-link">
    <link rel="apple-touch-icon" href="./logo_default.png" id="apple-touch-link">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cars Management System</title>
    <script>
      // Update favicon based on logged-in user
      (function() {
        function updateFavicon(iconUrl) {
          const faviconLink = document.getElementById('favicon-link')
          const appleTouchLink = document.getElementById('apple-touch-link')
          if (faviconLink) faviconLink.href = iconUrl
          if (appleTouchLink) appleTouchLink.href = iconUrl
        }

        function getBasePath() {
          const pathname = window.location.pathname
          const match = pathname.match(/^(\/[^/]+\/)/)
          return match ? match[1] : '/'
        }

        function getApiBase() {
          return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8000/api'
            : 'https://www.merhab.com/api'
        }

        function getFileUrl(path, baseDirectory) {
          if (!path || typeof path !== 'string' || path.trim() === '') {
            return ''
          }
          if (path.startsWith('http://') || path.startsWith('https://')) {
            return path
          }
          const apiBase = getApiBase()
          const uploadUrl = apiBase + '/upload.php'
          const url = new URL(uploadUrl)
          url.searchParams.set('path', path.replace(/^\/+/, ''))
          if (baseDirectory) {
            url.searchParams.set('base_directory', baseDirectory)
          }
          return url.toString()
        }

        async function fetchDifferentCompanyUserLogo(user) {
          if (!user || !user.path_logo || typeof user.path_logo !== 'string' || user.path_logo.trim() === '') return null
          const basePath = getBasePath()
          const apiBase = getApiBase()
          try {
            const dbCodeRes = await fetch(basePath + 'db_code.json')
            const dbCodeData = await dbCodeRes.json()
            if (!dbCodeData || !dbCodeData.db_code) return null
            const dbRes = await fetch(apiBase + '/db_manager_api.php?action=get_database_by_code&db_code=' + encodeURIComponent(dbCodeData.db_code))
            const dbResult = await dbRes.json()
            if (!dbResult.success || !dbResult.data) return null
            const filesDir = dbResult.data.files_dir || ''
            return getFileUrl(user.path_logo, filesDir)
          } catch (e) {}
          return null
        }

        async function fetchUserBankCompanyName(user) {
          if (!user || !user.id_bank_account) return null
          const basePath = getBasePath()
          const apiBase = getApiBase()
          try {
            const dbCodeRes = await fetch(basePath + 'db_code.json')
            const dbCodeData = await dbCodeRes.json()
            if (!dbCodeData || !dbCodeData.db_code) return null
            const dbRes = await fetch(apiBase + '/db_manager_api.php?action=get_database_by_code&db_code=' + encodeURIComponent(dbCodeData.db_code))
            const dbResult = await dbRes.json()
            if (!dbResult.success || !dbResult.data || !dbResult.data.db_name) return null
            const apiRes = await fetch(apiBase + '/api.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                query: 'SELECT company_name FROM banks WHERE id = ?',
                params: [user.id_bank_account],
                dbname: dbResult.data.db_name
              })
            })
            const apiResult = await apiRes.json()
            if (apiResult.success && apiResult.data && apiResult.data[0] && apiResult.data[0].company_name) {
              return apiResult.data[0].company_name
            }
          } catch (e) {}
          return null
        }

        async function fetchActiveBankLogo() {
          const basePath = getBasePath()
          const apiBase = getApiBase()
          try {
            const dbCodeRes = await fetch(basePath + 'db_code.json')
            const dbCodeData = await dbCodeRes.json()
            if (!dbCodeData || !dbCodeData.db_code) return null
            const dbRes = await fetch(apiBase + '/db_manager_api.php?action=get_database_by_code&db_code=' + encodeURIComponent(dbCodeData.db_code))
            const dbResult = await dbRes.json()
            if (!dbResult.success || !dbResult.data || !dbResult.data.db_name) return null
            const apiRes = await fetch(apiBase + '/api.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                query: 'SELECT logo_path FROM banks WHERE is_active = 1 LIMIT 1',
                params: [],
                dbname: dbResult.data.db_name
              })
            })
            const apiResult = await apiRes.json()
            if (apiResult.success && apiResult.data && apiResult.data[0] && apiResult.data[0].logo_path) {
              const filesDir = dbResult.data.files_dir || ''
              return getFileUrl(apiResult.data[0].logo_path, filesDir)
            }
          } catch (e) {}
          return null
        }

        async function loadFavicon() {
          const basePath = getBasePath()
          const defaultTitle = 'Cars Management System'
          const userStr = localStorage.getItem('user')

          if (userStr) {
            try {
              const user = JSON.parse(userStr)
              const isDifferentCompany = user && (
                user.is_diffrent_company === 1 ||
                user.is_diffrent_company === true ||
                user.is_diffrent_company === '1'
              )

              if (isDifferentCompany) {
                var companyName = await fetchUserBankCompanyName(user)
                document.title = companyName ? (companyName + ' - Cars Management System') : defaultTitle
                var userLogoUrl = await fetchDifferentCompanyUserLogo(user)
                if (userLogoUrl) {
                  updateFavicon(userLogoUrl)
                  return
                }
                updateFavicon(basePath + 'logo_default.png')
                return
              }
            } catch (e) {}
          }

          document.title = defaultTitle
          var activeBankLogoUrl = await fetchActiveBankLogo()
          if (activeBankLogoUrl) {
            updateFavicon(activeBankLogoUrl)
            return
          }

          updateFavicon(basePath + 'logo.png')
        }

        // Update favicon on page load
        loadFavicon()

        // Listen for user login/logout events
        window.addEventListener('storage', (e) => {
          if (e.key === 'user') {
            loadFavicon()
          }
        })
        window.addEventListener('userLogin', loadFavicon)
        window.addEventListener('userLogout', loadFavicon)
        window.addEventListener('companyInfoUpdated', function() {
          window.location.reload()
        })
      })()
    </script>
  </head>
  <body>
    <div id="app"></div>
    <script>
      // Add error handler for module loading failures
      window.addEventListener('error', (event) => {
        if (event.target && event.target.tagName === 'SCRIPT') {
          // Script loading error - handled silently
        }
      }, true)
    </script>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
